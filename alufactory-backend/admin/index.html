<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alufactory ç®¡ç†åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background: #1f2937;
            color: white;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar h1 {
            font-size: 24px;
            margin-bottom: 30px;
            font-weight: 700;
        }
        
        .nav-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .nav-item:hover {
            background: #374151;
        }
        
        .nav-item.active {
            background: #3b82f6;
            font-weight: 600;
        }
        
        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 30px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .header h2 {
            font-size: 28px;
            color: #1f2937;
        }
        
        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .table-wrapper {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-box {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            width: 300px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f9fafb;
            padding: 12px 20px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        td {
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            margin-right: 5px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-confirmed {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-shipped {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-delivered {
            background: #c7d2fe;
            color: #3730a3;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 20px;
            padding: 20px;
        }
        
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .pagination button.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h1>Alufactory</h1>
            <nav>
                <div class="nav-item active" onclick="switchTab('dashboard')">ğŸ“Š ä»ªè¡¨æ¿</div>
                <div class="nav-item" onclick="switchTab('users')">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</div>
                <!-- <div class="nav-item" onclick="switchTab('profiles')">ğŸ“‹ ç”¨æˆ·èµ„æ–™</div> -->
                <div class="nav-item" onclick="switchTab('orders')">ğŸ“¦ è®¢å•ç®¡ç†</div>
                <div class="nav-item logout-btn" onclick="logout()">ğŸšª é€€å‡º</div>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h2 id="pageTitle">ä»ªè¡¨æ¿</h2>
                <div id="userInfo" style="font-size: 14px; color: #6b7280;"></div>
            </div>
            
            <!-- Dashboard -->
            <div id="dashboard" class="content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>æ€»ç”¨æˆ·æ•°</h3>
                        <div class="value" id="totalUsers">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ´»è·ƒç”¨æˆ·</h3>
                        <div class="value" id="activeUsers">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ€»è®¢å•æ•°</h3>
                        <div class="value" id="totalOrders">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>å¾…å¤„ç†è®¢å•</h3>
                        <div class="value" id="pendingOrders">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>å·²å‘è´§è®¢å•</h3>
                        <div class="value" id="shippedOrders">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ€»æ”¶å…¥</h3>
                        <div class="value" id="totalRevenue">Â¥0</div>
                    </div>
                </div>
            </div>
            
            <!-- Users Management -->
            <div id="users" class="content hidden">
                <div class="table-wrapper">
                    <div class="table-header">
                        <h3>ç”¨æˆ·åˆ—è¡¨</h3>
                        <input type="text" class="search-box" id="userSearch" placeholder="æœç´¢ç”¨æˆ·...">
                    </div>
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·å</th>
                                <th>ç”µè¯</th>
                                <th>é‚®ç®±</th>
                                <th>ä¼šå‘˜çº§åˆ«</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                        </tbody>
                    </table>
                    <div class="pagination" id="usersPagination"></div>
                </div>
            </div>
            
            <!-- Profiles Management -->
            <div id="profiles" class="content hidden">
                <div class="table-wrapper">
                    <div class="table-header">
                        <h3>ç”¨æˆ·èµ„æ–™åˆ—è¡¨</h3>
                        <input type="text" class="search-box" id="profileSearch" placeholder="æœç´¢èµ„æ–™...">
                    </div>
                    <table id="profilesTable">
                        <thead>
                            <tr>
                                <th>èµ„æ–™åç§°</th>
                                <th>ç”¨æˆ·</th>
                                <th>ç”µè¯</th>
                                <th>æ”¶è´§åœ°å€</th>
                                <th>PDF</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="profilesTableBody">
                        </tbody>
                    </table>
                    <div class="pagination" id="profilesPagination"></div>
                </div>
            </div>
            
            <!-- Orders Management -->
            <div id="orders" class="content hidden">
                <div class="table-wrapper">
                    <div class="table-header">
                        <h3>è®¢å•åˆ—è¡¨</h3>
                        <select class="search-box" id="orderFilter" onchange="filterOrders()">
                            <option value="">æ‰€æœ‰è®¢å•</option>
                            <option value="pending">å¾…å¤„ç†</option>
                            <option value="confirmed">å·²ç¡®è®¤</option>
                            <option value="shipped">å·²å‘è´§</option>
                            <option value="delivered">å·²é€è¾¾</option>
                        </select>
                    </div>
                    <table id="ordersTable">
                        <thead>
                            <tr>
                                <th>è®¢å•å·</th>
                                <th>ç”¨æˆ·å</th>
                                <th>ç”¨æˆ·ç”µè¯</th>
                                <th>å®¢æˆ·ç”µè¯</th>
                                <th>å®¢æˆ·</th>
                                <th>æ€»é‡‘é¢</th>
                                <th>çŠ¶æ€</th>
                                <th>æ—¥æœŸ</th>
                                <th>PDF</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                        </tbody>
                    </table>
                    <div class="pagination" id="ordersPagination"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Order Modal -->
    <div id="editOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ç¼–è¾‘è®¢å•</div>
            <div class="form-group">
                <label>è®¢å•çŠ¶æ€</label>
                <select id="orderStatus">
                    <option value="pending">å¾…å¤„ç†</option>
                    <option value="confirmed">å·²ç¡®è®¤</option>
                    <option value="shipped">å·²å‘è´§</option>
                    <option value="delivered">å·²é€è¾¾</option>
                    <option value="cancelled">å·²å–æ¶ˆ</option>
                </select>
            </div>
            <div class="form-group">
                <label>è¿½è¸ªå·</label>
                <input type="text" id="trackingNumber" placeholder="è¾“å…¥è¿½è¸ªå·">
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨</label>
                <textarea id="orderMemo" rows="3" placeholder="è¾“å…¥è®¢å•å¤‡æ³¨"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="saveOrder()">ä¿å­˜</button>
                <button class="btn" onclick="closeModal('editOrderModal')" style="background: #e5e7eb; color: #1f2937;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ç¼–è¾‘ç”¨æˆ·</div>
            <div class="form-group">
                <label>ä¼šå‘˜çº§åˆ«</label>
                <select id="userMembership">
                    <option value="standard">æ ‡å‡†</option>
                    <option value="vip">VIP</option>
                    <option value="vip_plus">VIP+</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="userActive"> æ¿€æ´»è´¦æˆ·
                </label>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="saveUser()">ä¿å­˜</button>
                <button class="btn" onclick="closeModal('editUserModal')" style="background: #e5e7eb; color: #1f2937;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- User Details Modal -->
    <div id="userDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">ç”¨æˆ·è¯¦æƒ…</div>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="userDetailsUsername" readonly>
            </div>
            <div class="form-group">
                <label>ç”µè¯</label>
                <input type="text" id="userDetailsPhone" readonly>
            </div>
            <div class="form-group">
                <label>é‚®ç®±</label>
                <input type="text" id="userDetailsEmail" readonly>
            </div>
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="userDetailsFullName" readonly>
            </div>
            <div class="form-group">
                <label>ä¼šå‘˜çº§åˆ«</label>
                <input type="text" id="userDetailsMembership" readonly>
            </div>
            <div class="form-group">
                <label>æ³¨å†Œæ—¶é—´</label>
                <input type="text" id="userDetailsCreated" readonly>
            </div>
            <div class="form-group">
                <label style="font-weight: 700; margin-bottom: 10px;">æ”¶è´§åœ°å€ (å…±<span id="userAddressCount">0</span>ä¸ª)</label>
                <div id="userAddressesList" style="border: 1px solid #d1d5db; border-radius: 6px; padding: 10px; max-height: 300px; overflow-y: auto;">
                </div>
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeModal('userDetailsModal')" style="background: #e5e7eb; color: #1f2937;">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- Profile Details Modal -->
    <div id="profileDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">èµ„æ–™è¯¦æƒ…</div>
            <div class="form-group">
                <label>èµ„æ–™åç§°</label>
                <input type="text" id="profileViewName" readonly>
            </div>
            <div class="form-group">
                <label>ç”¨æˆ·</label>
                <input type="text" id="profileViewUser" readonly>
            </div>
            <div class="form-group">
                <label>ç”¨æˆ·ç”µè¯</label>
                <input type="text" id="profileViewUserPhone" readonly>
            </div>
            <div class="form-group">
                <label>æ”¶è´§äººå§“å</label>
                <input type="text" id="profileViewRecipient" readonly>
            </div>
            <div class="form-group">
                <label>æ”¶è´§äººç”µè¯</label>
                <input type="text" id="profileViewPhone" readonly>
            </div>
            <div class="form-group">
                <label>åœ°åŒº</label>
                <input type="text" id="profileViewProvince" readonly>
            </div>
            <div class="form-group">
                <label>è¯¦ç»†åœ°å€</label>
                <textarea id="profileViewDetail" readonly rows="3"></textarea>
            </div>
            <div class="form-group" id="pdfDownloadGroup">
                <label>PDFæ–‡ä»¶</label>
                <button class="btn btn-primary" id="downloadPdfBtn" onclick="downloadProfilePdf()">ä¸‹è½½PDF</button>
            </div>
            <div class="form-group">
                <label>åˆ›å»ºæ—¶é—´</label>
                <input type="text" id="profileViewCreated" readonly>
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeModal('profileDetailsModal')" style="background: #e5e7eb; color: #1f2937;">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:5000/api';
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let currentEditingOrder = null;
        let currentEditingUser = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (!authToken) {
                window.location.href = 'login.html';
                return;
            }
            
            getCurrentUser();
            loadDashboard();
        });
        
        // Get current user
        async function getCurrentUser() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Unauthorized');
                
                const data = await response.json();
                currentUser = data.user;
                
                if (!currentUser.is_admin) {
                    alert('ä»…ç®¡ç†å‘˜å¯è®¿é—®æ­¤é¡µé¢');
                    logout();
                }
                
                document.getElementById('userInfo').textContent = `æ¬¢è¿, ${currentUser.username}`;
            } catch (error) {
                console.error(error);
                logout();
            }
        }
        
        // Switch tabs
        function switchTab(tab) {
            // Hide all content
            document.querySelectorAll('.content').forEach(el => el.classList.add('hidden'));
            
            // Show selected
            document.getElementById(tab).classList.remove('hidden');
            
            // Update nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update title
            const titles = {
                'dashboard': 'ä»ªè¡¨æ¿',
                'users': 'ç”¨æˆ·ç®¡ç†',
                'profiles': 'ç”¨æˆ·èµ„æ–™',
                'orders': 'è®¢å•ç®¡ç†'
            };
            document.getElementById('pageTitle').textContent = titles[tab];
            
            // Load data
            if (tab === 'users') loadUsers();
            if (tab === 'profiles') loadProfiles();
            if (tab === 'orders') loadOrders();
        }
        
        // Load dashboard
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/admin/statistics`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load statistics');
                
                const data = await response.json();
                
                document.getElementById('totalUsers').textContent = data.total_users;
                document.getElementById('activeUsers').textContent = data.active_users;
                document.getElementById('totalOrders').textContent = data.total_orders;
                document.getElementById('pendingOrders').textContent = data.pending_orders;
                document.getElementById('shippedOrders').textContent = data.shipped_orders;
                document.getElementById('totalRevenue').textContent = 'Â¥' + data.total_revenue.toFixed(2);
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        // Load users
        async function loadUsers(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/admin/users?page=${page}&per_page=20`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load users');
                
                const data = await response.json();
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';
                
                data.users.forEach(user => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.phone}</td>
                        <td>${user.email || '-'}</td>
                        <td>${user.membership_level}</td>
                        <td>${user.is_active ? 'æ¿€æ´»' : 'ç¦ç”¨'}</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewUserDetails('${user.id}')">æŸ¥çœ‹è¯¦æƒ…</button>
                            <button class="btn btn-primary" onclick="editUser('${user.id}')">ç¼–è¾‘</button>
                            ${!user.is_active ? `<button class="btn btn-success" onclick="activateUser('${user.id}')">æ¿€æ´»</button>` : ''}
                        </td>
                    `;
                });
                
                // Pagination
                renderPagination('usersPagination', page, data.pages, loadUsers);
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        // Load orders
        async function loadOrders(page = 1, status = '') {
            try {
                const url = status 
                    ? `${API_BASE}/admin/orders?page=${page}&per_page=20&status=${status}`
                    : `${API_BASE}/admin/orders?page=${page}&per_page=20`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load orders');
                
                const data = await response.json();
                const tbody = document.getElementById('ordersTableBody');
                tbody.innerHTML = '';
                
                data.orders.forEach(order => {
                    const row = tbody.insertRow();
                    const date = new Date(order.created_at).toLocaleDateString('zh-CN');
                    const userName = order.user?.username || '-';
                    const userPhone = order.user?.phone || '-';
                    const customerPhone = order.customer_phone || '-';
                          const pdfLink = order.pdf?.available && order.pdf?.url
                                ? `<button class="btn btn-success" style="padding: 6px 8px;" onclick="openOrderPdf('${order.pdf.url}', '${order.pdf.filename || ''}', false)">æ‰“å¼€</button>
                                    <button class="btn btn-primary" style="padding: 6px 8px;" onclick="openOrderPdf('${order.pdf.url}', '${order.pdf.filename || ''}', true)">ä¸‹è½½</button>`
                                : '-';
                    row.innerHTML = `
                        <td>${order.order_number}</td>
                        <td>${userName}</td>
                        <td>${userPhone}</td>
                        <td>${customerPhone}</td>
                        <td>${order.recipient_name}</td>
                        <td>Â¥${order.total_amount.toFixed(2)}</td>
                        <td><span class="status-badge status-${order.status}">${getStatusText(order.status)}</span></td>
                        <td>${date}</td>
                        <td>${pdfLink}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editOrder('${order.id}')">ç¼–è¾‘</button>
                        </td>
                    `;
                });
                
                // Pagination
                renderPagination('ordersPagination', page, data.pages, (p) => loadOrders(p, status));
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }
        
        // Load profiles
        async function loadProfiles(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/admin/profiles?page=${page}&per_page=20`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load profiles');
                
                const data = await response.json();
                const tbody = document.getElementById('profilesTableBody');
                tbody.innerHTML = '';
                
                data.profiles.forEach(profile => {
                    const row = tbody.insertRow();
                    const date = new Date(profile.created_at).toLocaleDateString('zh-CN');
                    const hasPdf = profile.pdf_filename ? 'âœ“' : '-';
                    row.innerHTML = `
                        <td>${profile.profile_name || '-'}</td>
                        <td>${profile.user.username}</td>
                        <td>${profile.user.phone}</td>
                        <td>${profile.address.province || '-'}</td>
                        <td>${hasPdf}</td>
                        <td>${date}</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewProfile('${profile.id}')">æŸ¥çœ‹</button>
                        </td>
                    `;
                });
                
                // Pagination
                renderPagination('profilesPagination', page, data.pages, loadProfiles);
            } catch (error) {
                console.error('Error loading profiles:', error);
            }
        }
        
        // View profile details
        async function viewProfile(profileId) {
            try {
                const response = await fetch(`${API_BASE}/admin/profiles/${profileId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load profile');
                
                const data = await response.json();
                const profile = data.profile;
                
                // Fill form
                document.getElementById('profileViewName').value = profile.profile_name || '-';
                document.getElementById('profileViewUser').value = profile.user.username;
                document.getElementById('profileViewUserPhone').value = profile.user.phone;
                document.getElementById('profileViewRecipient').value = profile.address.recipient_name || '-';
                document.getElementById('profileViewPhone').value = profile.address.phone || '-';
                document.getElementById('profileViewProvince').value = profile.address.province || '-';
                document.getElementById('profileViewDetail').value = profile.address.detail || '-';
                document.getElementById('profileViewCreated').value = new Date(profile.created_at).toLocaleDateString('zh-CN');
                
                // Handle PDF button
                const pdfBtn = document.getElementById('downloadPdfBtn');
                if (profile.pdf_base64) {
                    pdfBtn.style.display = 'inline-block';
                    pdfBtn.onclick = () => downloadProfilePdf(profile);
                } else {
                    pdfBtn.style.display = 'none';
                }
                
                // Store current profile for download
                window.currentViewProfile = profile;
                
                document.getElementById('profileDetailsModal').classList.add('active');
            } catch (error) {
                alert('é”™è¯¯: ' + error.message);
            }
        }
        
        // Download profile PDF
        function downloadProfilePdf(profile) {
            profile = profile || window.currentViewProfile;
            if (!profile || !profile.pdf_base64) {
                alert('æ²¡æœ‰PDFæ–‡ä»¶');
                return;
            }
            
            try {
                // Decode base64 and create blob
                const binaryString = atob(profile.pdf_base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const blob = new Blob([bytes], { type: 'application/pdf' });
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = profile.pdf_filename || 'profile.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                alert('ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }
        
        // Edit order
        function editOrder(orderId) {
            currentEditingOrder = orderId;
            document.getElementById('editOrderModal').classList.add('active');
        }
        
        // Save order
        async function saveOrder() {
            try {
                const response = await fetch(`${API_BASE}/admin/orders/${currentEditingOrder}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: document.getElementById('orderStatus').value,
                        tracking_number: document.getElementById('trackingNumber').value,
                        memo: document.getElementById('orderMemo').value
                    })
                });
                
                if (!response.ok) throw new Error('Failed to save order');
                
                alert('è®¢å•å·²ä¿å­˜');
                closeModal('editOrderModal');
                loadOrders();
            } catch (error) {
                alert('é”™è¯¯: ' + error.message);
            }
        }
        
        // Edit user
        function editUser(userId) {
            currentEditingUser = userId;
            document.getElementById('editUserModal').classList.add('active');
        }
        
        // View user details with addresses
        async function viewUserDetails(userId) {
            try {
                const response = await fetch(`${API_BASE}/admin/users?page=1&per_page=1000`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load user');
                
                const data = await response.json();
                const user = data.users.find(u => u.id === userId);
                
                if (!user) throw new Error('User not found');
                
                document.getElementById('userDetailsUsername').value = user.username;
                document.getElementById('userDetailsPhone').value = user.phone;
                document.getElementById('userDetailsEmail').value = user.email || '-';
                document.getElementById('userDetailsFullName').value = user.full_name || '-';
                document.getElementById('userDetailsMembership').value = user.membership_level;
                document.getElementById('userDetailsCreated').value = new Date(user.created_at).toLocaleString('zh-CN');
                
                const addressesList = document.getElementById('userAddressesList');
                const addresses = user.addresses || [];
                document.getElementById('userAddressCount').textContent = addresses.length;
                
                if (addresses.length === 0) {
                    addressesList.innerHTML = '<p style="color: #999; text-align: center; padding: 10px;">æš‚æ— åœ°å€</p>';
                } else {
                    addressesList.innerHTML = addresses.map((addr, idx) => `
                        <div style="padding: 10px; border-bottom: 1px solid #e5e7eb; ${idx === addresses.length - 1 ? 'border-bottom: none;' : ''}">
                            <div style="font-weight: 600; margin-bottom: 5px;">åœ°å€ ${idx + 1}${addr.is_default ? ' <span style="color: #ef4444;">(é»˜è®¤)</span>' : ''}</div>
                            <div style="font-size: 13px; color: #666; line-height: 1.6;">
                                <div><strong>æ”¶ä»¶äºº:</strong> ${addr.recipient_name}</div>
                                <div><strong>ç”µè¯:</strong> ${addr.phone}</div>
                                <div><strong>çœä»½:</strong> ${addr.province}</div>
                                <div><strong>è¯¦ç»†åœ°å€:</strong> ${addr.detail}</div>
                                <div style="font-size: 12px; color: #999; margin-top: 5px;">åˆ›å»º: ${new Date(addr.created_at).toLocaleString('zh-CN')}</div>
                            </div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('userDetailsModal').classList.add('active');
            } catch (error) {
                alert('é”™è¯¯: ' + error.message);
            }
        }
        
        // Save user
        async function saveUser() {
            try {
                const response = await fetch(`${API_BASE}/admin/users/${currentEditingUser}/membership`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        membership_level: document.getElementById('userMembership').value
                    })
                });
                
                if (!response.ok) throw new Error('Failed to save user');
                
                alert('ç”¨æˆ·å·²ä¿å­˜');
                closeModal('editUserModal');
                loadUsers();
            } catch (error) {
                alert('é”™è¯¯: ' + error.message);
            }
        }
        
        // Activate user
        async function activateUser(userId) {
            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}/activate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to activate user');
                
                alert('ç”¨æˆ·å·²æ¿€æ´»');
                loadUsers();
            } catch (error) {
                alert('é”™è¯¯: ' + error.message);
            }
        }
        
        // Filter orders
        function filterOrders() {
            const status = document.getElementById('orderFilter').value;
            loadOrders(1, status);
        }

        async function openOrderPdf(url, filename, download = false) {
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to load PDF');

                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);

                if (download) {
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = filename || 'document.pdf';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(blobUrl);
                } else {
                    window.open(blobUrl, '_blank');
                }
            } catch (error) {
                alert('PDFåŠ è½½å¤±è´¥: ' + error.message);
            }
        }
        
        // Utilities
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        function getStatusText(status) {
            const texts = {
                'pending': 'å¾…å¤„ç†',
                'confirmed': 'å·²ç¡®è®¤',
                'shipped': 'å·²å‘è´§',
                'delivered': 'å·²é€è¾¾',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return texts[status] || status;
        }
        
        function renderPagination(id, current, total, callback) {
            const container = document.getElementById(id);
            container.innerHTML = '';
            
            for (let i = 1; i <= total; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                if (i === current) btn.classList.add('active');
                btn.onclick = () => callback(i);
                container.appendChild(btn);
            }
        }
        
        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
